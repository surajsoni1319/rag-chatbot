<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- ‚úÖ BUG #14 FIX: CSRF token for fetch() requests -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Star Cement AI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
    <style>
        /* ‚úÖ BUG #13 FIX: Password field styles */
        .password-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .password-input-wrapper input {
            width: 100%;
            padding-right: 45px;
        }

        .toggle-password-btn {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
            color: #666;
            transition: color 0.2s;
            line-height: 1;
        }

        .toggle-password-btn:hover {
            color: #1D3557;
        }

        /* Strength bar */
        .strength-bar-container {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .strength-bar {
            height: 4px;
            flex: 1;
            border-radius: 2px;
            background: #e5e7eb;
            transition: background 0.3s ease;
        }

        .strength-bar.weak {
            background: #ef4444;
        }

        .strength-bar.fair {
            background: #f97316;
        }

        .strength-bar.good {
            background: #eab308;
        }

        .strength-bar.strong {
            background: #22c55e;
        }

        .strength-label {
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }

        .strength-label.weak {
            color: #ef4444;
        }

        .strength-label.fair {
            color: #f97316;
        }

        .strength-label.good {
            color: #eab308;
        }

        .strength-label.strong {
            color: #22c55e;
        }

        /* Requirements checklist */
        .password-requirements {
            list-style: none;
            padding: 6px 0 0 0;
            margin: 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        .password-requirements li {
            font-size: 12px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }

        .password-requirements li.met {
            color: #22c55e;
        }

        .password-requirements li::before {
            content: "‚úó";
            font-weight: bold;
            color: #ef4444;
            font-size: 12px;
        }

        .password-requirements li.met::before {
            content: "‚úì";
            color: #22c55e;
        }

        #passwordStrengthWrapper {
            display: none;
            margin-top: 4px;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <h2>üè¢ Star Cement AI</h2>
                <p class="admin-badge">Admin Panel</p>
            </div>

            <nav class="nav-menu">
                <a href="{{ url_for('admin_dashboard') }}" class="nav-item">
                    <span class="icon">üìä</span> Dashboard
                </a>
                <a href="{{ url_for('admin_documents') }}" class="nav-item">
                    <span class="icon">üìÅ</span> Documents
                </a>
                <a href="{{ url_for('admin_users') }}" class="nav-item active">
                    <span class="icon">üë•</span> Users
                </a>
                <a href="{{ url_for('admin_queries') }}" class="nav-item">
                    <span class="icon">‚ùì</span> Unanswered Queries
                </a>
                <a href="{{ url_for('admin_feedback_review') }}" class="nav-item">
                    <span class="icon">üí¨</span> User Feedback
                </a>
                <a href="{{ url_for('admin_analytics') }}" class="nav-item">
                    <span class="icon">üìà</span> Analytics
                </a>
                <a href="{{ url_for('admin_upload') }}" class="nav-item upload-btn">
                    <span class="icon">‚¨ÜÔ∏è</span> Upload Documents
                </a>
            </nav>

            <div class="nav-footer">
                <a href="{{ url_for('home') }}" class="nav-item">
                    <span class="icon">üí¨</span> Chat Interface
                </a>
                <a href="{{ url_for('logout') }}" class="nav-item logout">
                    <span class="icon">üö™</span> Logout
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="admin-header">
                <div class="header-left">
                    <h1>User Management</h1>
                    <p class="breadcrumb">Home / Users</p>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <div class="user-details">
                            <span class="user-name">{{ current_user.name or current_user.email.split('@')[0] }}</span>
                            <span class="user-role">{{ current_user.role|title }}</span>
                        </div>
                        <div class="user-avatar">{{ current_user.email[0]|upper }}</div>
                    </div>
                </div>
            </header>

            <!-- Filters -->
            <section class="filters-section">
                <div class="search-box">
                    <input type="text" id="searchUsers" placeholder="üîç Search users...">
                </div>
                <div class="filter-group">
                    <select id="filterDept">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept|upper }}</option>
                        {% endfor %}
                    </select>
                    <select id="filterRole">
                        <option value="">All Roles</option>
                        <option value="admin">Admin</option>
                        <option value="user">User</option>
                    </select>
                    <select id="filterAccess">
                        <option value="">All Access Levels</option>
                        <option value="public">Public</option>
                        <option value="employee">Employee</option>
                        <option value="manager">Manager</option>
                        <option value="senior_mgmt">Senior Management</option>
                        <option value="executive">Executive</option>
                    </select>
                </div>
            </section>

            <!-- Users Table -->
            <section class="content-section">
                <div class="section-header">
                    <h2>üë• All Users ({{ users|length }})</h2>
                    <button class="btn-primary" onclick="openAddUserModal()">
                        ‚ûï Add New User
                    </button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Department</th>
                                <th>Role</th>
                                <th>Access Level</th>
                                <th>Last Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable">
                            {% for user in users %}
                            <tr data-dept="{{ user.department }}" data-role="{{ user.role }}"
                                data-access="{{ user.access_level }}">
                                <td>
                                    <div class="user-cell">
                                        <div class="user-avatar-small">{{ user.email[0]|upper }}</div>
                                        <span>{{ user.name or 'Not Set' }}</span>
                                    </div>
                                </td>
                                <td>{{ user.email }}</td>
                                <td><span class="badge dept-badge">{{ user.department|upper }}</span></td>
                                <td><span class="badge role-badge {{ user.role }}">{{ user.role|title }}</span></td>
                                <td><span class="badge access-badge {{ user.access_level }}">{{
                                        user.access_level|replace('_', ' ')|title }}</span></td>
                                <td>{{ user.last_active or 'Never' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-icon" onclick="editUser({{ user.id }})"
                                            title="Edit">‚úèÔ∏è</button>
                                        {% if user.id != current_user.id %}
                                        <button class="btn-icon danger"
                                            onclick="deleteUser({{ user.id }}, '{{ user.email }}')"
                                            title="Delete">üóëÔ∏è</button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content large">
            <h3 id="modalTitle">‚ûï Add New User</h3>
            <form id="userForm">
                <input type="hidden" id="userId" name="user_id">

                <div class="form-row">
                    <div class="form-group">
                        <label for="userName">Full Name <span class="required">*</span></label>
                        <input type="text" id="userName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Email <span class="required">*</span></label>
                        <input type="email" id="userEmail" name="email" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="userDept">Department <span class="required">*</span></label>
                        <select id="userDept" name="department" required>
                            <option value="">Select Department</option>
                            <option value="it">IT</option>
                            <option value="hr">HR</option>
                            <option value="finance">Finance</option>
                            <option value="operations">Operations</option>
                            <option value="sales">Sales</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userRole">Role <span class="required">*</span></label>
                        <select id="userRole" name="role" required>
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="userAccess">Access Level <span class="required">*</span></label>
                    <select id="userAccess" name="access_level" required>
                        <option value="employee">Employee</option>
                        <option value="manager">Manager</option>
                        <option value="senior_mgmt">Senior Management</option>
                        <option value="executive">Executive</option>
                    </select>
                </div>

                <!-- ‚úÖ BUG #13 FIX: Password field with show/hide + strength indicator -->
                <div class="form-group" id="passwordGroup">
                    <label for="userPassword">Password <span class="required">*</span></label>

                    <!-- Show/Hide Password Input -->
                    <div class="password-input-wrapper">
                        <input type="password" id="userPassword" name="password" placeholder="Enter a strong password">
                        <button type="button" class="toggle-password-btn" onclick="togglePasswordVisibility()"
                            id="togglePasswordBtn" title="Show/Hide Password">
                            üëÅÔ∏è
                        </button>
                    </div>

                    <small id="passwordHint">Leave blank to keep existing password (for edit)</small>

                    <!-- Strength Indicator (shows when typing) -->
                    <div id="passwordStrengthWrapper">
                        <div class="strength-bar-container">
                            <div class="strength-bar" id="bar1"></div>
                            <div class="strength-bar" id="bar2"></div>
                            <div class="strength-bar" id="bar3"></div>
                            <div class="strength-bar" id="bar4"></div>
                            <div class="strength-bar" id="bar5"></div>
                        </div>
                        <div class="strength-label" id="strengthLabel"></div>
                        <ul class="password-requirements">
                            <li id="req-length">At least 8 characters</li>
                            <li id="req-upper">1 uppercase letter (A-Z)</li>
                            <li id="req-lower">1 lowercase letter (a-z)</li>
                            <li id="req-number">1 number (0-9)</li>
                            <li id="req-special">1 special character (!@#$...)</li>
                        </ul>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" onclick="closeUserModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Confirm Delete</h3>
            <p>Are you sure you want to delete user <strong id="deleteUserEmail"></strong>?</p>
            <p class="warning-text">This will also delete all their chat history.</p>
            <div class="modal-buttons">
                <button onclick="closeDeleteModal()" class="btn-secondary">Cancel</button>
                <button onclick="confirmDelete()" class="btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='admin.js') }}"></script>
    <script>
        let deleteUserId = null;

        // ‚úÖ BUG #14 FIX: Get CSRF token for all fetch requests
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Helper function for fetch with CSRF token
        async function fetchWithCSRF(url, options = {}) {
            return fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    ...(options.headers || {})
                }
            });
        }

        // ============================================================
        // ‚úÖ BUG #13 FIX: Show/Hide Password Toggle
        // ============================================================
        function togglePasswordVisibility() {
            const input = document.getElementById('userPassword');
            const btn = document.getElementById('togglePasswordBtn');

            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'üôà';
                btn.title = 'Hide Password';
            } else {
                input.type = 'password';
                btn.textContent = 'üëÅÔ∏è';
                btn.title = 'Show Password';
            }
        }

        // ============================================================
        // ‚úÖ BUG #13 FIX: Password Strength Indicator
        // ============================================================
        const requirements = {
            'req-length': (p) => p.length >= 8,
            'req-upper': (p) => /[A-Z]/.test(p),
            'req-lower': (p) => /[a-z]/.test(p),
            'req-number': (p) => /\d/.test(p),
            'req-special': (p) => /[!@#$%^&*(),.?":{}|<>\-_\[\]\/\\]/.test(p)
        };

        const strengthConfig = {
            0: { label: '', cls: '' },
            1: { label: 'Weak', cls: 'weak' },
            2: { label: 'Weak', cls: 'weak' },
            3: { label: 'Fair', cls: 'fair' },
            4: { label: 'Good', cls: 'good' },
            5: { label: 'Strong', cls: 'strong' }
        };

        document.getElementById('userPassword').addEventListener('input', function () {
            const password = this.value;
            const wrapper = document.getElementById('passwordStrengthWrapper');

            if (password.length === 0) {
                wrapper.style.display = 'none';
                return;
            }

            wrapper.style.display = 'block';

            // Check each requirement
            let score = 0;
            for (const [id, checkFn] of Object.entries(requirements)) {
                const el = document.getElementById(id);
                const passed = checkFn(password);
                el.classList.toggle('met', passed);
                if (passed) score++;
            }

            // Update strength bars
            const config = strengthConfig[score];
            for (let i = 1; i <= 5; i++) {
                const bar = document.getElementById(`bar${i}`);
                bar.className = 'strength-bar';
                if (i <= score) bar.classList.add(config.cls);
            }

            // Update strength label
            const label = document.getElementById('strengthLabel');
            label.textContent = config.label ? `Password Strength: ${config.label}` : '';
            label.className = `strength-label ${config.cls}`;
        });

        // ============================================================
        // Filter functionality
        // ============================================================
        document.getElementById('searchUsers').addEventListener('input', filterUsers);
        document.getElementById('filterDept').addEventListener('change', filterUsers);
        document.getElementById('filterRole').addEventListener('change', filterUsers);
        document.getElementById('filterAccess').addEventListener('change', filterUsers);

        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const deptFilter = document.getElementById('filterDept').value;
            const roleFilter = document.getElementById('filterRole').value;
            const accessFilter = document.getElementById('filterAccess').value;

            const rows = document.querySelectorAll('#usersTable tr');

            rows.forEach(row => {
                const email = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                const name = row.querySelector('.user-cell span').textContent.toLowerCase();
                const dept = row.dataset.dept;
                const role = row.dataset.role;
                const access = row.dataset.access;

                const matchesSearch = email.includes(searchTerm) || name.includes(searchTerm);
                const matchesDept = !deptFilter || dept === deptFilter;
                const matchesRole = !roleFilter || role === roleFilter;
                const matchesAccess = !accessFilter || access === accessFilter;

                row.style.display = (matchesSearch && matchesDept && matchesRole && matchesAccess) ? '' : 'none';
            });
        }

        function openAddUserModal() {
            document.getElementById('modalTitle').textContent = '‚ûï Add New User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('userPassword').type = 'password';
            document.getElementById('togglePasswordBtn').textContent = 'üëÅÔ∏è';
            document.getElementById('passwordStrengthWrapper').style.display = 'none';
            document.getElementById('userModal').style.display = 'flex';
        }

        function editUser(userId) {
            fetchWithCSRF(`/admin/users/${userId}`, { method: 'GET' })
                .then(response => response.json())
                .then(user => {
                    document.getElementById('modalTitle').textContent = '‚úèÔ∏è Edit User';
                    document.getElementById('userId').value = user.id;
                    document.getElementById('userName').value = user.name || '';
                    document.getElementById('userEmail').value = user.email;
                    document.getElementById('userDept').value = user.department;
                    document.getElementById('userRole').value = user.role;
                    document.getElementById('userAccess').value = user.access_level;
                    document.getElementById('userPassword').required = false;
                    document.getElementById('userPassword').value = '';
                    document.getElementById('userPassword').type = 'password';
                    document.getElementById('togglePasswordBtn').textContent = 'üëÅÔ∏è';
                    document.getElementById('passwordStrengthWrapper').style.display = 'none';
                    document.getElementById('userModal').style.display = 'flex';
                });
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            // Reset password field state
            document.getElementById('userPassword').type = 'password';
            document.getElementById('togglePasswordBtn').textContent = 'üëÅÔ∏è';
            document.getElementById('passwordStrengthWrapper').style.display = 'none';
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            // ‚úÖ BUG #13 FIX: Frontend password validation before submitting
            if (data.password) {
                const checks = [
                    data.password.length >= 8,
                    /[A-Z]/.test(data.password),
                    /[a-z]/.test(data.password),
                    /\d/.test(data.password),
                    /[!@#$%^&*(),.?":{}|<>\-_\[\]\/\\]/.test(data.password)
                ];

                if (!checks.every(Boolean)) {
                    alert('‚ùå Password does not meet requirements.\n\nPassword must have:\n‚úì At least 8 characters\n‚úì 1 uppercase letter (A-Z)\n‚úì 1 lowercase letter (a-z)\n‚úì 1 number (0-9)\n‚úì 1 special character (!@#$%^&*)');
                    return;
                }
            }

            const url = data.user_id ? `/admin/users/${data.user_id}/edit` : '/admin/users/add';
            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                const response = await fetchWithCSRF(url, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.status === 'success') {
                    closeUserModal();
                    alert(result.message || 'User saved successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + result.message);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Save User';
                }
            } catch (error) {
                alert('Error: ' + error);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save User';
            }
        });

        function deleteUser(userId, userEmail) {
            deleteUserId = userId;
            document.getElementById('deleteUserEmail').textContent = userEmail;
            document.getElementById('deleteModal').style.display = 'flex';
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            deleteUserId = null;
        }

        function confirmDelete() {
            if (deleteUserId) {
                fetchWithCSRF(`/admin/users/${deleteUserId}/delete`, { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            closeDeleteModal();
                            alert(data.message || 'User deleted successfully!');
                            location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error);
                    });
            }
        }

        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>

</html>